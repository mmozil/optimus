# ==========================================
# Agent Optimus â€” CD Pipeline (Deploy)
# ==========================================
# Triggers: push to main (after CI passes)
# Deploys via Coolify webhook

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    # Only deploy if CI passed
    needs: []  # Runs independently, CI is enforced via branch protection

    steps:
      - uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Trigger Coolify Deploy
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Trigger Coolify webhook
        if: env.COOLIFY_WEBHOOK_URL != ''
        env:
          COOLIFY_WEBHOOK_URL: ${{ secrets.COOLIFY_WEBHOOK_URL }}
        run: |
          curl -fsSL -X POST "$COOLIFY_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{"ref": "${{ github.ref }}", "sha": "${{ github.sha }}"}'
          echo "âœ… Coolify deploy triggered"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Notify on Telegram
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Telegram
        if: env.TELEGRAM_BOT_TOKEN != '' && always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS=${{ job.status }}
          EMOJI="âœ…"
          if [ "$STATUS" != "success" ]; then EMOJI="âŒ"; fi

          MESSAGE="$EMOJI *Agent Optimus Deploy*%0A"
          MESSAGE+="Status: $STATUS%0A"
          MESSAGE+="Branch: ${{ github.ref_name }}%0A"
          MESSAGE+="Commit: \`${{ github.sha }}\`%0A"
          MESSAGE+="By: ${{ github.actor }}"

          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Notify on Slack
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL != '' && always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS=${{ job.status }}
          COLOR="#36a64f"
          if [ "$STATUS" != "success" ]; then COLOR="#ff0000"; fi

          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"Agent Optimus Deploy â€” $STATUS\",
                \"fields\": [
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"${{ github.sha }}\", \"short\": true},
                  {\"title\": \"By\", \"value\": \"${{ github.actor }}\", \"short\": true}
                ]
              }]
            }"
