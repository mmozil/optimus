<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configura√ß√µes ‚Äî Optimus</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      border-bottom: 1px solid #1e1e1e;
    }

    .back-btn {
      color: #666;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .back-btn:hover { color: #aaa; }

    .header-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }

    .container {
      max-width: 560px;
      width: 100%;
      margin: 40px auto;
      padding: 0 24px;
    }

    .section {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 13px;
      color: #aaa;
      margin-bottom: 6px;
    }

    input, select {
      width: 100%;
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 11px 13px;
      font-size: 14px;
      color: #e0e0e0;
      margin-bottom: 18px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus { border-color: #555; }
    select option { background: #1a1a1a; }

    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .btn {
      background: #fff;
      color: #000;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn:hover { opacity: 0.85; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .alert {
      border-radius: 8px;
      padding: 11px 14px;
      font-size: 13px;
      margin-bottom: 16px;
      display: none;
    }

    .alert-success { background: #0f2a1a; border: 1px solid #1a5a30; color: #5af098; }
    .alert-error { background: #2a1010; border: 1px solid #5a2020; color: #f88; }

    .profile-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    .profile-info { flex: 1; }
    .profile-name { font-size: 16px; font-weight: 600; color: #fff; }
    .profile-email { font-size: 13px; color: #666; margin-top: 2px; }

    .api-key-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .api-key-row input { flex: 1; margin-bottom: 0; font-family: monospace; font-size: 12px; }

    .copy-btn {
      background: #2a2a2a;
      color: #aaa;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 11px 14px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .copy-btn:hover { color: #fff; border-color: #555; }

    /* Reflection cards */
    .reflection-card {
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .reflection-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 10px 14px;
      cursor: pointer;
      background: #111;
      user-select: none;
    }
    .reflection-header:hover { background: #1a1a1a; }
    .reflection-week { font-weight: 600; font-size: .85rem; color: #e0e0e0; }
    .reflection-period { font-size: .78rem; color: #737373; flex: 1; }
    .reflection-toggle { font-size: .75rem; color: #555; }
    .reflection-body { padding: 0 14px 14px; background: #0d0d0d; }
  </style>
</head>
<body>
  <header>
    <a href="/" class="back-btn">‚Üê Voltar</a>
    <span class="header-title">Configura√ß√µes</span>
  </header>

  <div class="container">
    <div id="alert-success" class="alert alert-success"></div>
    <div id="alert-error" class="alert alert-error"></div>

    <!-- Profile -->
    <div class="section">
      <div class="section-title">Perfil</div>
      <div class="profile-row">
        <div class="avatar" id="avatar-letter">?</div>
        <div class="profile-info">
          <div class="profile-name" id="profile-name">Carregando...</div>
          <div class="profile-email" id="profile-email"></div>
        </div>
      </div>

      <label for="display_name">Nome de exibi√ß√£o</label>
      <input type="text" id="display_name" placeholder="Como aparece no perfil">

      <button class="btn" onclick="saveProfile()">Salvar perfil</button>
    </div>

    <!-- Change Password -->
    <div class="section">
      <div class="section-title">Alterar senha</div>

      <label for="current-password">Senha atual</label>
      <input type="password" id="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

      <label for="new-password" style="margin-top:12px;">Nova senha</label>
      <input type="password" id="new-password" placeholder="M√≠nimo 8 caracteres">

      <label for="confirm-password" style="margin-top:12px;">Confirmar nova senha</label>
      <input type="password" id="confirm-password" placeholder="Repita a nova senha">

      <button class="btn" onclick="changePassword()" style="margin-top:12px;">Alterar senha</button>
    </div>

    <!-- Preferences -->
    <div class="section">
      <div class="section-title">Prefer√™ncias</div>

      <label for="preferred_name">Como seu assistente deve te chamar</label>
      <input type="text" id="preferred_name" placeholder="Ex: Marcelo">

      <label for="agent_name">Como voc√™ chama seu assistente</label>
      <input type="text" id="agent_name" placeholder="Ex: Optimus, Max, Aria">

      <div class="field-row">
        <div>
          <label for="language">Idioma</label>
          <select id="language">
            <option value="pt-BR">Portugu√™s (BR)</option>
            <option value="en">English</option>
            <option value="es">Espa√±ol</option>
          </select>
        </div>
        <div>
          <label for="communication_style">Estilo</label>
          <select id="communication_style">
            <option value="casual">Casual</option>
            <option value="formal">Formal</option>
            <option value="technical">T√©cnico</option>
          </select>
        </div>
      </div>

      <button class="btn" onclick="savePreferences()">Salvar prefer√™ncias</button>
    </div>

    <!-- Integra√ß√µes Google -->
    <div class="section">
      <div class="section-title">Integra√ß√µes Google</div>
      <p style="font-size:13px;color:#666;margin-bottom:16px;">
        Conecte sua conta Google para que o agente possa ler emails, eventos do Calendar e arquivos do Drive.
      </p>
      <div id="google-disconnected" style="display:none;">
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:13px;color:#888;">Gmail ¬∑ Calendar ¬∑ Drive ‚Äî n√£o conectado</span>
          <button class="btn" onclick="connectGoogle()" style="background:#4285F4;">
            üîó Conectar Google
          </button>
        </div>
      </div>
      <div id="google-connected" style="display:none;">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
          <span style="font-size:13px;color:#4ade80;">‚úÖ Conectado como <strong id="google-email"></strong></span>
          <span style="font-size:12px;color:#555;" id="google-scopes"></span>
          <button class="btn" onclick="disconnectGoogle()" style="background:#333;color:#e0e0e0;font-size:12px;padding:8px 14px;">
            Desconectar
          </button>
        </div>
      </div>
      <div id="google-loading" style="font-size:13px;color:#555;">Verificando conex√£o...</div>
    </div>

    <!-- Emails IMAP/SMTP -->
    <div class="section">
      <div class="section-title">Emails (IMAP/SMTP)</div>
      <p style="font-size:13px;color:#666;margin-bottom:16px;">
        Conecte contas de email via IMAP/SMTP: Outlook, Office 365, Yahoo, corporativo e outros provedores.
      </p>

      <!-- Account list -->
      <div id="imap-accounts-list" style="margin-bottom:16px;"></div>

      <!-- Add account form (toggle) -->
      <div id="imap-add-form" style="display:none;background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:16px;margin-bottom:12px;">
        <div style="font-size:13px;font-weight:600;margin-bottom:12px;">Adicionar Conta de Email</div>

        <div style="display:grid;gap:10px;">
          <div>
            <label style="font-size:12px;color:#aaa;">Provedor</label>
            <select id="imap-provider" onchange="onImapProviderChange()" style="width:100%;background:#0d0d0d;border:1px solid #333;border-radius:6px;padding:8px;color:#e0e0e0;font-size:13px;margin-top:4px;">
              <option value="outlook">Outlook / Hotmail / Live</option>
              <option value="office365">Office 365 / Exchange Online</option>
              <option value="yahoo">Yahoo Mail</option>
              <option value="gmail">Gmail (App Password)</option>
              <option value="locaweb">Locaweb</option>
              <option value="hostgator">HostGator Brasil</option>
              <option value="uol">UOL Mail</option>
              <option value="terra">Terra</option>
              <option value="custom">Personalizado (IMAP/SMTP pr√≥prio)</option>
            </select>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div>
              <label style="font-size:12px;color:#aaa;">Email</label>
              <input type="email" id="imap-email" placeholder="usuario@outlook.com" style="width:100%;background:#0d0d0d;border:1px solid #333;border-radius:6px;padding:8px;color:#e0e0e0;font-size:13px;margin-top:4px;box-sizing:border-box;">
            </div>
            <div>
              <label style="font-size:12px;color:#aaa;">Senha / App Password</label>
              <input type="password" id="imap-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;background:#0d0d0d;border:1px solid #333;border-radius:6px;padding:8px;color:#e0e0e0;font-size:13px;margin-top:4px;box-sizing:border-box;">
            </div>
          </div>

          <div id="imap-custom-fields" style="display:none;display:grid;grid-template-columns:1fr 80px 1fr 80px;gap:8px;">
            <div>
              <label style="font-size:12px;color:#aaa;">IMAP Host</label>
              <input type="text" id="imap-host" placeholder="imap.suaempresa.com" style="width:100%;background:#0d0d0d;border:1px solid #333;border-radius:6px;padding:8px;color:#e0e0e0;font-size:13px;margin-top:4px;box-sizing:border-box;">
            </div>
            <div>
              <label style="font-size:12px;color:#aaa;">Porta</label>
              <input type="number" id="imap-port" value="993" style="width:100%;background:#0d0d0d;border:1px solid #333;border-radius:6px;padding:8px;color:#e0e0e0;font-size:13px;margin-top:4px;box-sizing:border-box;">
            </div>
            <div>
              <label style="font-size:12px;color:#aaa;">SMTP Host</label>
              <input type="text" id="smtp-host" placeholder="smtp.suaempresa.com" style="width:100%;background:#0d0d0d;border:1px solid #333;border-radius:6px;padding:8px;color:#e0e0e0;font-size:13px;margin-top:4px;box-sizing:border-box;">
            </div>
            <div>
              <label style="font-size:12px;color:#aaa;">Porta</label>
              <input type="number" id="smtp-port" value="587" style="width:100%;background:#0d0d0d;border:1px solid #333;border-radius:6px;padding:8px;color:#e0e0e0;font-size:13px;margin-top:4px;box-sizing:border-box;">
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:4px;">
            <button class="btn" onclick="saveImapAccount()" style="flex:1;">üíæ Salvar</button>
            <button class="btn" onclick="document.getElementById('imap-add-form').style.display='none'" style="background:#333;color:#e0e0e0;">Cancelar</button>
          </div>
        </div>
      </div>

      <button class="btn" onclick="document.getElementById('imap-add-form').style.display='block'" style="font-size:13px;padding:8px 16px;">
        ‚ûï Adicionar Conta de Email
      </button>
    </div>

    <!-- Apple iCloud (FASE 8) -->
    <div class="section">
      <div class="section-title"> Apple iCloud</div>
      <p style="font-size:13px;color:#666;margin-bottom:16px;">
        Conecte sua conta Apple para acessar <strong>Calendar, Reminders e Contacts</strong> via iCloud.
        Para iCloud Mail, use a se√ß√£o "Emails (IMAP/SMTP)" acima com o preset iCloud.<br><br>
        ‚ö†Ô∏è Use uma <strong>App-Specific Password</strong> ‚Äî <em>n√£o</em> sua senha Apple ID normal.<br>
        <a href="https://appleid.apple.com" target="_blank" style="color:#3b82f6;text-decoration:none;">
          Gerar em appleid.apple.com ‚Üí Seguran√ßa ‚Üí Senhas espec√≠ficas para apps ‚Üó
        </a>
      </p>

      <!-- Status conectado -->
      <div id="apple-loading" style="font-size:13px;color:#666;">Verificando...</div>
      <div id="apple-connected" style="display:none;background:#0d1f0d;border:1px solid #1a3a1a;border-radius:8px;padding:12px 16px;margin-bottom:12px;">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
          <div>
            <span style="color:#4ade80;font-weight:600;">‚úÖ Conectado:</span>
            <span id="apple-id-display" style="color:#e0e0e0;margin-left:8px;font-size:13px;"></span>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn" onclick="testAppleConnection()" style="font-size:12px;padding:6px 12px;background:#1e3a1e;">
              üîÑ Testar
            </button>
            <button class="btn" onclick="removeAppleCredentials()" style="font-size:12px;padding:6px 12px;background:#3a1e1e;color:#f87171;">
              üóë Desconectar
            </button>
          </div>
        </div>
        <div id="apple-test-result" style="font-size:12px;color:#aaa;margin-top:8px;display:none;"></div>
      </div>

      <!-- Formul√°rio de conex√£o -->
      <div id="apple-disconnected" style="display:none;">
        <div style="display:grid;gap:12px;">
          <div>
            <label style="font-size:12px;color:#aaa;display:block;margin-bottom:4px;">Apple ID (email)</label>
            <input type="email" id="apple-id-input" placeholder="seu@icloud.com"
              style="width:100%;background:#0d0d0d;border:1px solid #333;border-radius:6px;padding:8px;color:#e0e0e0;font-size:13px;box-sizing:border-box;">
          </div>
          <div>
            <label style="font-size:12px;color:#aaa;display:block;margin-bottom:4px;">App-Specific Password</label>
            <input type="password" id="apple-password-input" placeholder="xxxx-xxxx-xxxx-xxxx"
              style="width:100%;background:#0d0d0d;border:1px solid #333;border-radius:6px;padding:8px;color:#e0e0e0;font-size:13px;box-sizing:border-box;">
          </div>
          <button class="btn" onclick="saveAppleCredentials()" style="width:fit-content;">
            üçé Salvar e Testar Conex√£o
          </button>
        </div>
      </div>
    </div>

    <!-- Reflex√£o Semanal -->
    <div class="section">
      <div class="section-title">üß† Reflex√£o Semanal</div>
      <p style="font-size:13px;color:#666;margin-bottom:16px;">
        An√°lise autom√°tica de padr√µes das √∫ltimas intera√ß√µes ‚Äî t√≥picos frequentes, lacunas de conhecimento e sugest√µes. Roda todo domingo (7 dias).
      </p>
      <button class="btn" id="btn-reflect-now" onclick="triggerReflection()" style="width:fit-content;margin-bottom:20px;background:#1a1a1a;color:#e0e0e0;border:1px solid #333;">
        ‚ö° Gerar Agora
      </button>
      <div id="reflection-list"></div>
    </div>

    <!-- API Key -->
    <div class="section">
      <div class="section-title">API Key</div>
      <p style="font-size:13px;color:#666;margin-bottom:16px;">
        Use esta chave para acessar a API do Optimus programaticamente via <code style="color:#aaa;">X-API-Key</code>.
      </p>
      <div class="api-key-row">
        <input type="password" id="api-key-input" value="" readonly>
        <button class="copy-btn" onclick="toggleApiKey()">Mostrar</button>
        <button class="copy-btn" onclick="copyApiKey()">Copiar</button>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('optimus_token');
    if (!token) window.location.href = '/login.html';

    let apiKeyVisible = false;
    let profileData = {};
    let prefsData = {};

    function showSuccess(msg) {
      const el = document.getElementById('alert-success');
      const err = document.getElementById('alert-error');
      err.style.display = 'none';
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    function showError(msg) {
      const el = document.getElementById('alert-error');
      const ok = document.getElementById('alert-success');
      ok.style.display = 'none';
      el.textContent = msg;
      el.style.display = 'block';
    }

    // Tiny MD5 for Gravatar (RFC 1321 ‚Äî no external dependency)
    function md5(str) {
      function safeAdd(x,y){const lsw=(x&0xFFFF)+(y&0xFFFF),msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);}
      function bitRotateLeft(num,cnt){return(num<<cnt)|(num>>>(32-cnt));}
      function md5cmn(q,a,b,x,s,t){return safeAdd(bitRotateLeft(safeAdd(safeAdd(a,q),safeAdd(x,t)),s),b);}
      function md5ff(a,b,c,d,x,s,t){return md5cmn((b&c)|(~b&d),a,b,x,s,t);}
      function md5gg(a,b,c,d,x,s,t){return md5cmn((b&d)|(c&~d),a,b,x,s,t);}
      function md5hh(a,b,c,d,x,s,t){return md5cmn(b^c^d,a,b,x,s,t);}
      function md5ii(a,b,c,d,x,s,t){return md5cmn(c^(b|(~d)),a,b,x,s,t);}
      let b=[];for(let i=0;i<str.length;i++){const c=str.charCodeAt(i);if(c<128)b.push(c);else if(c<2048)b.push(192|(c>>6),128|(c&63));else b.push(224|(c>>12),128|((c>>6)&63),128|(c&63));}
      b.push(128);const l=b.length;const extra=56-l%64;for(let i=0;i<(extra<0?extra+64:extra);i++)b.push(0);const bits=8*(l-1);b.push(bits&0xFF,(bits>>8)&0xFF,(bits>>16)&0xFF,(bits>>24)&0xFF,0,0,0,0);
      let w=[],a=1732584193,bv=-271733879,c=-1732584194,d=271733878;
      for(let i=0;i<b.length;i+=64){for(let j=0;j<16;j++)w[j]=(b[i+j*4])|(b[i+j*4+1]<<8)|(b[i+j*4+2]<<16)|(b[i+j*4+3]<<24);
      let ta=a,tb=bv,tc=c,td=d;
      a=md5ff(a,bv,c,d,w[0],7,-680876936);d=md5ff(d,a,bv,c,w[1],12,-389564586);c=md5ff(c,d,a,bv,w[2],17,606105819);bv=md5ff(bv,c,d,a,w[3],22,-1044525330);a=md5ff(a,bv,c,d,w[4],7,-176418897);d=md5ff(d,a,bv,c,w[5],12,1200080426);c=md5ff(c,d,a,bv,w[6],17,-1473231341);bv=md5ff(bv,c,d,a,w[7],22,-45705983);a=md5ff(a,bv,c,d,w[8],7,1770035416);d=md5ff(d,a,bv,c,w[9],12,-1958414417);c=md5ff(c,d,a,bv,w[10],17,-42063);bv=md5ff(bv,c,d,a,w[11],22,-1990404162);a=md5ff(a,bv,c,d,w[12],7,1804603682);d=md5ff(d,a,bv,c,w[13],12,-40341101);c=md5ff(c,d,a,bv,w[14],17,-1502002290);bv=md5ff(bv,c,d,a,w[15],22,1236535329);
      a=md5gg(a,bv,c,d,w[1],5,-165796510);d=md5gg(d,a,bv,c,w[6],9,-1069501632);c=md5gg(c,d,a,bv,w[11],14,643717713);bv=md5gg(bv,c,d,a,w[0],20,-373897302);a=md5gg(a,bv,c,d,w[5],5,-701558691);d=md5gg(d,a,bv,c,w[10],9,38016083);c=md5gg(c,d,a,bv,w[15],14,-660478335);bv=md5gg(bv,c,d,a,w[4],20,-405537848);a=md5gg(a,bv,c,d,w[9],5,568446438);d=md5gg(d,a,bv,c,w[14],9,-1019803690);c=md5gg(c,d,a,bv,w[3],14,-187363961);bv=md5gg(bv,c,d,a,w[8],20,1163531501);a=md5gg(a,bv,c,d,w[13],5,-1444681467);d=md5gg(d,a,bv,c,w[2],9,-51403784);c=md5gg(c,d,a,bv,w[7],14,1735328473);bv=md5gg(bv,c,d,a,w[12],20,-1926607734);
      a=md5hh(a,bv,c,d,w[5],4,-378558);d=md5hh(d,a,bv,c,w[8],11,-2022574463);c=md5hh(c,d,a,bv,w[11],16,1839030562);bv=md5hh(bv,c,d,a,w[14],23,-35309556);a=md5hh(a,bv,c,d,w[1],4,-1530992060);d=md5hh(d,a,bv,c,w[4],11,1272893353);c=md5hh(c,d,a,bv,w[7],16,-155497632);bv=md5hh(bv,c,d,a,w[10],23,-1094730640);a=md5hh(a,bv,c,d,w[13],4,681279174);d=md5hh(d,a,bv,c,w[0],11,-358537222);c=md5hh(c,d,a,bv,w[3],16,-722521979);bv=md5hh(bv,c,d,a,w[6],23,76029189);a=md5hh(a,bv,c,d,w[9],4,-640364487);d=md5hh(d,a,bv,c,w[12],11,-421815835);c=md5hh(c,d,a,bv,w[15],16,530742520);bv=md5hh(bv,c,d,a,w[2],23,-995338651);
      a=md5ii(a,bv,c,d,w[0],6,-198630844);d=md5ii(d,a,bv,c,w[7],10,1126891415);c=md5ii(c,d,a,bv,w[14],15,-1416354905);bv=md5ii(bv,c,d,a,w[5],21,-57434055);a=md5ii(a,bv,c,d,w[12],6,1700485571);d=md5ii(d,a,bv,c,w[3],10,-1894986606);c=md5ii(c,d,a,bv,w[10],15,-1051523);bv=md5ii(bv,c,d,a,w[1],21,-2054922799);a=md5ii(a,bv,c,d,w[8],6,1873313359);d=md5ii(d,a,bv,c,w[15],10,-30611744);c=md5ii(c,d,a,bv,w[6],15,-1560198380);bv=md5ii(bv,c,d,a,w[13],21,1309151649);a=md5ii(a,bv,c,d,w[4],6,-145523070);d=md5ii(d,a,bv,c,w[11],10,-1120210379);c=md5ii(c,d,a,bv,w[2],15,718787259);bv=md5ii(bv,c,d,a,w[9],21,-343485551);
      a=safeAdd(a,ta);bv=safeAdd(bv,tb);c=safeAdd(c,tc);d=safeAdd(d,td);}
      return[a,bv,c,d].map(n=>(n<0?n+4294967296:n).toString(16).padStart(8,'0').match(/../g).map(x=>x[1]+x[0]).join('')).join('');
    }

    function setAvatarGravatar(email, fallbackLetter) {
      const hash = md5(email.trim().toLowerCase());
      const url = `https://www.gravatar.com/avatar/${hash}?s=52&d=404`;
      const avatarEl = document.getElementById('avatar-letter');
      const img = new Image();
      img.onload = () => {
        avatarEl.textContent = '';
        avatarEl.style.padding = '0';
        const imgEl = document.createElement('img');
        imgEl.src = url;
        imgEl.style.cssText = 'width:52px;height:52px;border-radius:50%;object-fit:cover;';
        avatarEl.appendChild(imgEl);
      };
      img.onerror = () => { avatarEl.textContent = fallbackLetter; };
      img.src = url;
    }

    async function loadProfile() {
      try {
        const resp = await fetch('/api/v1/user/profile', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!resp.ok) throw new Error('Failed to load profile');
        profileData = await resp.json();

        document.getElementById('display_name').value = profileData.display_name || '';
        document.getElementById('profile-name').textContent = profileData.display_name || profileData.email;
        document.getElementById('profile-email').textContent = profileData.email;
        const fallback = (profileData.display_name || profileData.email || '?')[0].toUpperCase();
        setAvatarGravatar(profileData.email, fallback);
      } catch (e) {
        showError('Erro ao carregar perfil: ' + e.message);
      }
    }

    async function loadPreferences() {
      try {
        const resp = await fetch('/api/v1/user/preferences', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!resp.ok) throw new Error('Failed to load preferences');
        prefsData = await resp.json();

        document.getElementById('preferred_name').value = prefsData.preferred_name || '';
        document.getElementById('agent_name').value = prefsData.agent_name || 'Optimus';
        document.getElementById('language').value = prefsData.language || 'pt-BR';
        document.getElementById('communication_style').value = prefsData.communication_style || 'casual';
      } catch (e) {
        console.warn('Could not load preferences:', e.message);
      }
    }

    async function loadApiKey() {
      try {
        const resp = await fetch('/api/v1/auth/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (resp.ok) {
          const data = await resp.json();
          if (data.api_key) {
            document.getElementById('api-key-input').value = data.api_key;
          }
        }
      } catch (e) {
        console.warn('Could not load API key');
      }
    }

    async function saveProfile() {
      const display_name = document.getElementById('display_name').value.trim();
      try {
        const resp = await fetch('/api/v1/user/profile', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ display_name }),
        });
        if (!resp.ok) throw new Error((await resp.json()).detail || 'Erro');
        document.getElementById('profile-name').textContent = display_name || profileData.email;
        document.getElementById('avatar-letter').textContent = (display_name || profileData.email || '?')[0].toUpperCase();
        showSuccess('Perfil atualizado! Fa√ßa login novamente para refletir no token.');
      } catch (e) {
        showError(e.message);
      }
    }

    async function changePassword() {
      const current = document.getElementById('current-password').value;
      const nw = document.getElementById('new-password').value;
      const confirm = document.getElementById('confirm-password').value;
      if (!current || !nw || !confirm) { showError('Preencha todos os campos.'); return; }
      if (nw.length < 8) { showError('Nova senha deve ter pelo menos 8 caracteres.'); return; }
      if (nw !== confirm) { showError('As senhas n√£o coincidem.'); return; }
      try {
        const resp = await fetch('/api/v1/user/password', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ current_password: current, new_password: nw }),
        });
        if (!resp.ok) throw new Error((await resp.json()).detail || 'Erro ao alterar senha');
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        showSuccess('Senha alterada com sucesso!');
      } catch (e) {
        showError(e.message);
      }
    }

    async function savePreferences() {
      const payload = {
        preferred_name: document.getElementById('preferred_name').value.trim(),
        agent_name: document.getElementById('agent_name').value.trim() || 'Optimus',
        language: document.getElementById('language').value,
        communication_style: document.getElementById('communication_style').value,
        timezone: 'America/Sao_Paulo',
      };
      try {
        const resp = await fetch('/api/v1/user/preferences', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error((await resp.json()).detail || 'Erro');
        showSuccess('Prefer√™ncias salvas! Aplicadas na pr√≥xima mensagem.');
      } catch (e) {
        showError(e.message);
      }
    }

    function toggleApiKey() {
      const input = document.getElementById('api-key-input');
      const btn = event.target;
      apiKeyVisible = !apiKeyVisible;
      input.type = apiKeyVisible ? 'text' : 'password';
      btn.textContent = apiKeyVisible ? 'Ocultar' : 'Mostrar';
    }

    function copyApiKey() {
      const val = document.getElementById('api-key-input').value;
      if (!val) return;
      navigator.clipboard.writeText(val).then(() => showSuccess('API key copiada!'));
    }

    // ============================================
    // Google OAuth Integration (FASE 4)
    // ============================================

    async function loadGoogleStatus() {
      try {
        const resp = await fetch('/api/v1/oauth/google/status', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        document.getElementById('google-loading').style.display = 'none';
        if (!resp.ok) {
          document.getElementById('google-disconnected').style.display = 'block';
          return;
        }
        const data = await resp.json();
        if (data.connected) {
          document.getElementById('google-email').textContent = data.google_email;
          const scopeLabels = data.scopes
            .filter(s => s.includes('googleapis'))
            .map(s => s.split('/').pop())
            .join(' ¬∑ ');
          document.getElementById('google-scopes').textContent = scopeLabels ? `(${scopeLabels})` : '';
          document.getElementById('google-connected').style.display = 'flex';
        } else {
          document.getElementById('google-disconnected').style.display = 'block';
        }
      } catch (e) {
        document.getElementById('google-loading').style.display = 'none';
        document.getElementById('google-disconnected').style.display = 'block';
      }
    }

    function connectGoogle() {
      window.location.href = `/api/v1/oauth/google/connect?token=${token}`;
    }

    async function disconnectGoogle() {
      if (!confirm('Desconectar o Google? O agente n√£o poder√° mais ler emails, calendar e drive.')) return;
      try {
        const resp = await fetch('/api/v1/oauth/google/revoke', {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (resp.ok) {
          showSuccess('Google desconectado.');
          document.getElementById('google-connected').style.display = 'none';
          document.getElementById('google-disconnected').style.display = 'block';
        } else {
          showError('Erro ao desconectar Google.');
        }
      } catch (e) {
        showError(e.message);
      }
    }

    // Handle redirect back from Google OAuth
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('google_connected')) {
      showSuccess(`‚úÖ Google conectado com sucesso (${urlParams.get('email') || ''})!`);
      window.history.replaceState({}, '', '/settings.html');
    } else if (urlParams.get('google_error')) {
      showError(`Erro ao conectar Google: ${urlParams.get('google_error')}`);
      window.history.replaceState({}, '', '/settings.html');
    }

    // Load everything on page load
    loadProfile();
    loadPreferences();
    loadApiKey();
    loadGoogleStatus();
    loadImapAccounts();
    loadAppleStatus();

    // ============================================
    // IMAP/SMTP Email Accounts (FASE 4C)
    // ============================================

    let imapProviders = {};

    async function loadImapAccounts() {
      try {
        // Load providers for form
        const pResp = await fetch('/api/v1/imap/providers');
        if (pResp.ok) imapProviders = await pResp.json();

        // Load user's accounts
        const resp = await fetch('/api/v1/imap/accounts', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!resp.ok) return;
        const data = await resp.json();
        renderImapAccounts(data.accounts || []);
      } catch (e) {
        console.warn('Could not load IMAP accounts:', e);
      }
    }

    function renderImapAccounts(accounts) {
      const container = document.getElementById('imap-accounts-list');
      if (!accounts.length) {
        container.innerHTML = '<p style="font-size:13px;color:#666;">Nenhuma conta configurada ainda.</p>';
        return;
      }
      container.innerHTML = accounts.map(acc => `
        <div style="display:flex;align-items:center;gap:12px;padding:10px;background:#1a1a1a;border:1px solid #333;border-radius:6px;margin-bottom:8px;">
          <span style="font-size:20px;">üìß</span>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:600;">${acc.display_name}</div>
            <div style="font-size:12px;color:#888;">${acc.provider} ¬∑ ${acc.imap_host}:${acc.imap_port}</div>
          </div>
          <button onclick="testImapAccount('${acc.email}')" class="btn" style="font-size:12px;padding:6px 10px;background:#333;">
            üîå Testar
          </button>
          <button onclick="removeImapAccount('${acc.email}')" class="btn" style="font-size:12px;padding:6px 10px;background:#c0392b;">
            üóëÔ∏è
          </button>
        </div>
      `).join('');
    }

    function onImapProviderChange() {
      const provider = document.getElementById('imap-provider').value;
      const customFields = document.getElementById('imap-custom-fields');
      const preset = imapProviders[provider];
      if (provider === 'custom' || !preset) {
        customFields.style.display = 'grid';
      } else {
        customFields.style.display = 'none';
        document.getElementById('imap-host').value = preset.imap_host;
        document.getElementById('imap-port').value = preset.imap_port;
        document.getElementById('smtp-host').value = preset.smtp_host;
        document.getElementById('smtp-port').value = preset.smtp_port;
      }
    }

    async function saveImapAccount() {
      const email = document.getElementById('imap-email').value.trim();
      const password = document.getElementById('imap-password').value;
      const provider = document.getElementById('imap-provider').value;

      if (!email || !password) {
        showError('Email e senha s√£o obrigat√≥rios.');
        return;
      }

      const preset = imapProviders[provider] || {};
      const body = {
        email, password, provider,
        imap_host: document.getElementById('imap-host').value || preset.imap_host || '',
        imap_port: parseInt(document.getElementById('imap-port').value) || preset.imap_port || 993,
        smtp_host: document.getElementById('smtp-host').value || preset.smtp_host || '',
        smtp_port: parseInt(document.getElementById('smtp-port').value) || preset.smtp_port || 587,
      };

      try {
        const resp = await fetch('/api/v1/imap/accounts', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await resp.json();
        if (resp.ok && data.ok) {
          showSuccess(`‚úÖ Conta ${email} adicionada com sucesso!`);
          document.getElementById('imap-add-form').style.display = 'none';
          document.getElementById('imap-email').value = '';
          document.getElementById('imap-password').value = '';
          await loadImapAccounts();
        } else {
          showError(data.detail || data.error || 'Erro ao salvar conta.');
        }
      } catch (e) {
        showError('Erro ao salvar conta: ' + e.message);
      }
    }

    async function removeImapAccount(email) {
      if (!confirm(`Remover a conta ${email}?`)) return;
      try {
        const resp = await fetch(`/api/v1/imap/accounts/${encodeURIComponent(email)}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` },
        });
        if (resp.ok) {
          showSuccess(`Conta ${email} removida.`);
          await loadImapAccounts();
        } else {
          showError('Erro ao remover conta.');
        }
      } catch (e) {
        showError(e.message);
      }
    }

    // ============================================
    // Apple iCloud (FASE 8)
    // ============================================

    async function loadAppleStatus() {
      try {
        const resp = await fetch('/api/v1/apple/status', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        document.getElementById('apple-loading').style.display = 'none';
        if (!resp.ok) { document.getElementById('apple-disconnected').style.display = 'block'; return; }
        const data = await resp.json();
        if (data.connected) {
          document.getElementById('apple-id-display').textContent = data.apple_id;
          document.getElementById('apple-connected').style.display = 'block';
        } else {
          document.getElementById('apple-disconnected').style.display = 'block';
        }
      } catch (e) {
        document.getElementById('apple-loading').style.display = 'none';
        document.getElementById('apple-disconnected').style.display = 'block';
      }
    }

    async function saveAppleCredentials() {
      const apple_id = document.getElementById('apple-id-input').value.trim();
      const app_password = document.getElementById('apple-password-input').value.trim();
      if (!apple_id || !app_password) { showError('Preencha Apple ID e App-Specific Password.'); return; }
      try {
        const resp = await fetch('/api/v1/apple/credentials', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ apple_id, app_password }),
        });
        if (!resp.ok) { const d = await resp.json(); throw new Error(d.detail || 'Erro'); }
        showSuccess('iCloud configurado! Testando conex√£o...');
        // Refresh status
        document.getElementById('apple-disconnected').style.display = 'none';
        document.getElementById('apple-id-display').textContent = apple_id;
        document.getElementById('apple-connected').style.display = 'block';
        // Live test
        await testAppleConnection();
      } catch (e) {
        showError('Erro: ' + e.message);
      }
    }

    async function testAppleConnection() {
      const resultEl = document.getElementById('apple-test-result');
      resultEl.style.display = 'block';
      resultEl.textContent = 'üîÑ Testando conex√£o CalDAV...';
      try {
        const resp = await fetch('/api/v1/apple/test', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await resp.json();
        if (data.ok) {
          resultEl.textContent = `‚úÖ Conectado! ${data.calendars_count} calend√°rio(s) encontrado(s).`;
          resultEl.style.color = '#4ade80';
        } else {
          resultEl.textContent = `‚ùå Falha: ${data.error}`;
          resultEl.style.color = '#f87171';
        }
      } catch (e) {
        resultEl.textContent = '‚ùå Erro de rede: ' + e.message;
        resultEl.style.color = '#f87171';
      }
    }

    async function removeAppleCredentials() {
      if (!confirm('Remover conta Apple iCloud?')) return;
      try {
        const resp = await fetch('/api/v1/apple/credentials', {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!resp.ok) throw new Error('Erro ao remover');
        document.getElementById('apple-connected').style.display = 'none';
        document.getElementById('apple-disconnected').style.display = 'block';
        document.getElementById('apple-id-input').value = '';
        document.getElementById('apple-password-input').value = '';
        showSuccess('Conta Apple iCloud removida.');
      } catch (e) {
        showError(e.message);
      }
    }

    async function testImapAccount(email) {
      showSuccess('Testando conex√£o...');
      try {
        const resp = await fetch('/api/v1/imap/accounts/test', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });
        const data = await resp.json();
        if (data.ok) {
          showSuccess(data.message);
        } else {
          showError(data.message);
        }
      } catch (e) {
        showError('Erro ao testar: ' + e.message);
      }
    }

    // ‚îÄ‚îÄ Reflex√£o Semanal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadReflections() {
      const wrap = document.getElementById('reflection-list');
      wrap.innerHTML = '<p style="color:#737373;font-size:.85rem">Carregando...</p>';
      try {
        const resp = await fetch('/api/v1/memory/reflections?agent=optimus', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await resp.json();
        const reports = data.data || [];
        if (reports.length === 0) {
          wrap.innerHTML = '<p style="color:#737373;font-size:.85rem">Nenhum relat√≥rio ainda. A primeira reflex√£o roda ap√≥s 7 dias de uso, ou clique em "Gerar Agora".</p>';
          return;
        }
        // Show latest by default
        wrap.innerHTML = reports.map((r, i) => `
          <div class="reflection-card${i === 0 ? ' active' : ''}" data-index="${i}" onclick="toggleReflection(${i})">
            <div class="reflection-header">
              <span class="reflection-week">üìÖ ${r.week}</span>
              <span class="reflection-period">${r.period}</span>
              <span class="reflection-toggle">${i === 0 ? '‚ñ≤' : '‚ñº'}</span>
            </div>
            <div class="reflection-body" id="reflection-body-${i}" style="display:${i === 0 ? 'block' : 'none'}">
              <pre style="white-space:pre-wrap;font-size:.82rem;color:#c9c9c9;margin:0.75rem 0 0">${escapeHtml(r.content)}</pre>
            </div>
          </div>
        `).join('');
      } catch (e) {
        wrap.innerHTML = `<p style="color:#ef4444;font-size:.85rem">Erro: ${e.message}</p>`;
      }
    }

    function toggleReflection(i) {
      const body = document.getElementById(`reflection-body-${i}`);
      const card = document.querySelector(`.reflection-card[data-index="${i}"]`);
      const toggle = card.querySelector('.reflection-toggle');
      const open = body.style.display === 'block';
      body.style.display = open ? 'none' : 'block';
      toggle.textContent = open ? '‚ñº' : '‚ñ≤';
    }

    async function triggerReflection() {
      const btn = document.getElementById('btn-reflect-now');
      btn.disabled = true;
      btn.textContent = 'Gerando...';
      try {
        const resp = await fetch('/api/v1/memory/reflections/trigger?agent=optimus', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        showSuccess('Relat√≥rio de reflex√£o gerado com sucesso!');
        await loadReflections();
      } catch (e) {
        showError('Erro ao gerar reflex√£o: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Gerar Agora';
      }
    }

    function escapeHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // init
    loadReflections();
  </script>
</body>
</html>
